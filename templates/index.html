<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Google Photos Style Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #1a73e8; --gray: #5f6368; }
        body { font-family: 'Roboto', sans-serif; margin: 0; background: #f8f9fa; display: flex; flex-direction: column; height: 100vh; }
        header { background: white; padding: 10px 20px; border-bottom: 1px solid #dadce0; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: 'Google Sans'; font-size: 22px; color: var(--gray); }
        main { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 300px; background: white; border-right: 1px solid #dadce0; padding: 20px; }
        .viewport { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .img-card { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 90%; max-height: 90%; }
        #display-image { max-width: 100%; max-height: 70vh; border-radius: 4px; display: none; }
        .control { margin-bottom: 20px; }
        label { display: block; font-size: 13px; color: var(--gray); font-weight: 500; margin-bottom: 5px; }
        input[type=range] { width: 100%; accent-color: var(--blue); }
        .btn { background: var(--blue); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-family: 'Google Sans'; }
        .btn:disabled { background: #ccc; }
    </style>
</head>
<body>

<header>
    <div class="logo">Gallery AI</div>
    <div>
        <input type="file" id="fileInput" hidden onchange="uploadImage()">
        <button class="btn" onclick="document.getElementById('fileInput').click()">Carica Foto</button>
        <a id="downloadBtn" href="#" download="edit.png" style="display:none; margin-left:10px;">
            <button class="btn" style="background: #34a853;">Scarica</button>
        </a>
    </div>
</header>

<main>
    <aside class="sidebar">
        <div class="control">
            <label>Luminosit√†</label>
            <input type="range" id="brightness" min="0.5" max="2" step="0.1" value="1" oninput="applyEdit()">
        </div>
        <div class="control">
            <label>Contrasto</label>
            <input type="range" id="contrast" min="0.5" max="2" step="0.1" value="1" oninput="applyEdit()">
        </div>
        <div class="control">
            <label>Saturazione</label>
            <input type="range" id="saturation" min="0" max="2" step="0.1" value="1" oninput="applyEdit()">
        </div>
        <div class="control">
            <label>Sfocatura</label>
            <input type="range" id="blur" min="0" max="5" step="0.5" value="0" oninput="applyEdit()">
        </div>
        <div class="control">
            <label>Rotazione</label>
            <input type="range" id="rotate" min="0" max="270" step="90" value="0" oninput="applyEdit()">
        </div>
    </aside>

    <section class="viewport">
        <div class="img-card" id="card">
            <p id="placeholder">Seleziona un'immagine per iniziare</p>
            <img id="display-image">
        </div>
    </section>
</main>

<script>
    let currentFile = "";
    let timer;

    async function uploadImage() {
        const file = document.getElementById('fileInput').files[0];
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch('/api/upload', { method: 'POST', body: formData });
        const data = await res.json();
        
        currentFile = data.filename;
        const img = document.getElementById('display-image');
        img.src = `/get-img/${currentFile}`;
        img.style.display = "block";
        document.getElementById('placeholder').style.display = "none";
        document.getElementById('downloadBtn').style.display = "inline-block";
    }

    function applyEdit() {
        if (!currentFile) return;
        clearTimeout(timer);
        
        // Aspetta 100ms che l'utente finisca di muovere lo slider
        timer = setTimeout(async () => {
            const payload = {
                filename: currentFile,
                value: {
                    brightness: document.getElementById('brightness').value,
                    contrast: document.getElementById('contrast').value,
                    saturation: document.getElementById('saturation').value,
                    blur: document.getElementById('blur').value,
                    rotate: document.getElementById('rotate').value
                }
            };

            const res = await fetch('/api/edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (data.temp_filename) {
                // IL FIX: Aggiungiamo un timestamp (?t=...) per forzare il refresh
                const finalUrl = `/get-img/${data.temp_filename}?t=${Date.now()}`;
                document.getElementById('display-image').src = finalUrl;
                document.getElementById('downloadBtn').href = finalUrl;
            }
        }, 100);
    }
</script>
</body>
</html>
