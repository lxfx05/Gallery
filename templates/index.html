// Sostituisci le funzioni handleUpload e fastEdit con queste:

async function handleUpload() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return;

    const fd = new FormData();
    fd.append('file', file);

    const res = await fetch('/api/upload', { method: 'POST', body: fd });
    const data = await res.json();
    
    currentFilename = data.filename;
    
    // Mostra subito l'immagine originale ricevuta in base64
    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('canvasContainer').style.display = 'block';
    document.getElementById('display-image').src = data.initial_image;
}

async function fastEdit() {
    if (!currentFilename) return;

    const payload = {
        filename: currentFilename,
        value: {
            brightness: document.getElementById('brightness').value,
            contrast: document.getElementById('contrast').value,
            saturation: document.getElementById('saturation').value,
            blur: document.getElementById('blur').value,
            rotate: document.getElementById('rotate').value
        }
    };

    // Invio immediato
    const res = await fetch('/api/edit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.image) {
        // Aggiornamento atomico del DOM
        document.getElementById('display-image').src = data.image;
        document.getElementById('downloadLink').href = data.image;
    }
}
